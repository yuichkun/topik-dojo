# write-test コマンド

指定されたReact Nativeコンポーネントのテストを作成してください。

## 作業手順

1. **既存テストパターンの確認**
   - `__tests__/screens/` 内の既存テスト（特に `TopScreen.test.tsx`）を参考にする
   - プロジェクトのテスト規約やパターンを理解する

2. **テストファイルの準備**
   - 適切な場所にテストファイルを作成（通常は `__tests__/screens/[ComponentName].test.tsx`）
   - 必要なインポートとモックを設定

3. **テストケースの実装**
   - コンポーネントが正しくレンダリングされるか
   - データが適切に表示されるか
   - ユーザーインタラクションが正しく動作するか
   - エラー状態やローディング状態の処理

4. **テストの実行と検証**
   - テストがパスすることを確認
   - 必要に応じて設定ファイルを更新

## 重要な原則

### データベースの扱い
このプロジェクトではWatermelonDBを**一切モックしません**。実際のデータベースインスタンスを使用してテストします。
テスト環境ではデータベースが自動的にクリーンアップされるため、実際のデータ操作をテストに含めることで信頼性の高いテストを実現します。

**重要**: 以下を含む全てのデータベース関連の処理をモックすることは禁止です：
- データベースクエリ関数（getGradeResults、createWordMasteryなど）
- WatermelonDBのコレクション操作
- データベース関連のユーティリティ関数

**データベースクリーンアップについて**:
- データベースのクリーンアップは `jest.setup.js` で既に自動化済み
- テストファイルにクリーンアップ処理を書く必要はない

エラー状態をテストしたい場合は、モックではなく実際のデータ不整合やバリデーション失敗などの実際の条件を作り出してください。

### モックすべきもの
- ネイティブモジュール（音声再生、カメラ、位置情報など）
- 外部API呼び出し
- アセットファイル（画像、音声ファイルなど）

### テストデータの準備
- データベースは `src/database` からインポート（グローバルインスタンス）
- テストヘルパー関数は `__tests__/helpers/databaseHelpers.ts` に定義
- ヘルパーがない場合は `database.write()` で直接作成可能

### UIコンポーネントのテスト
```typescript
// 例：ボタンのテスト
const touchableOpacities = component.root.findAllByType(TouchableOpacity);
const targetButton = touchableOpacities.find(button => {
  // ボタンを特定するロジック
});
```

### 非同期処理とタイミング

**禁止事項**:
- `setTimeout`による待機処理は使用禁止（不安定で信頼性が低い）

**推奨パターン**:
- 全ての非同期操作は`ReactTestRenderer.act()`内で処理
- データベース操作はコンポーネント作成前に実行

### Jest設定の更新
新しいライブラリを追加した場合、`jest.config.js` の更新が必要になることがあります：
- `transformIgnorePatterns` に新しいライブラリを追加
- `moduleNameMapper` でアセットファイルの拡張子を追加

## 期待される成果物

- 網羅的なテストケースを含むテストファイル
- 全てのテストがパスすること
- 必要に応じた設定ファイルの更新
- 将来の変更に対して堅牢なテスト
- **高速で安定したテスト**（`setTimeout`アンチパターンを避けることで実現）
- **信頼性の高いテスト**（実際のデータベース操作による統合テスト）

## 品質チェック

テスト作成後は以下を確認してください：
- [ ] データベース関連の関数をモックしていない
- [ ] `setTimeout`による待機処理を使用していない
- [ ] 追加のデータベースクリーンアップ処理を書いていない
- [ ] テストが高速で安定して実行される