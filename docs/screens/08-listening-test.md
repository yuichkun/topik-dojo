# リスニングテスト画面 仕様書

## 画面概要
選択されたユニットの単語を音声で出題し、4択の日本語訳から正解を選ぶテスト画面。

## レイアウト構成
- **ヘッダー**: 級+ユニット表示、進捗表示、戻るボタン
- **メインエリア**: 音声プレイヤー + 4択選択肢
- **フッター**: 次へボタン、音声再生ボタン

## UI要素詳細

### ヘッダー部分
- **級+ユニット表示**: 例「3級 リスニングテスト ユニット1-10 (5/10)」
- **進捗バー**: 現在の問題番号/総問題数の視覚表示
- **戻るボタン**: リスニングユニット選択画面へ戻る
- **配置**: 画面上部

### 音声プレイヤーエリア
- **音声再生ボタン**: 大きな再生ボタン（中央配置）
- **自動再生**: 画面表示時に自動で音声再生
- **再生回数制限**: なし（何度でも再生可能）
- **配置**: 画面中央上部

### 4択選択肢
- **選択肢表示**: 4つの日本語訳を縦並びで表示
- **選択状態**: タップで選択、選択中は色変更
- **選択肢生成**: 正解+似た意味の間違い選択肢3つ
- **配置**: 画面中央下部

### 操作ボタン
- **次へボタン**: 選択肢を選んだ後に有効化
- **音声再生ボタン**: 音声プレイヤーとは別の小さなボタン（フッター）
- **配置**: 画面下部

## 状態管理

### 画面パラメータ
- **級情報**: ナビゲーションパラメータで管理（例: `grade: 3`）
- **ユニット情報**: ナビゲーションパラメータで管理（例: `unit: 1`）
- **表示**: ヘッダー部分に級+ユニット表示

### テスト進捗管理
- **現在位置**: 何問目かをローカル状態で管理
- **回答状況**: 各問題の正解/不正解を記録
- **所要時間**: 問題ごとの回答時間を記録（将来の分析用）

## データ構造

### 問題データの取得
**データベース駆動**: WORDSテーブルから指定ユニットの単語を取得
- **メイン単語**: `SELECT w.* FROM words w JOIN units u ON w.unit_id = u.id WHERE u.id = ? ORDER BY w.unit_order`
- **間違い選択肢**: `SELECT japanese FROM words WHERE grade = ? AND id != ? ORDER BY RANDOM() LIMIT 3`

### 問題データ構造
```javascript
{
  id: "word_001",
  korean: "안녕하세요",
  japanese: "こんにちは",
  unit_id: "unit_3_1", 
  unit_order: 1,
  audio_url: "/audio/word_001.mp3",  // ファイルパスルールで生成
  correct_answer: "こんにちは",
  options: [
    "こんにちは",      // 正解
    "さようなら",      // 間違い選択肢（同級からランダム）
    "ありがとう",      // 間違い選択肢（同級からランダム）
    "すみません"       // 間違い選択肢（同級からランダム）
  ]
}
```

### テスト正解時の処理
```javascript
// 正解した単語をWORD_MASTERYテーブルに記録
{
  word_id: "word_001",
  test_type: "listening",
  mastered_date: Date.now() // UnixTimestamp
}
// 注意: 既に登録済みの場合は何もしない（UNIQUE制約）
```

## 機能詳細

### 音声再生
- **トリガー**: 画面表示時自動再生 + 手動ボタン
- **実装**: Expo AVまたはReact Native Sound
- **フォールバック**: 音声ファイルが存在しない場合はエラー表示

### 選択肢生成
- **正解**: 単語の正しい日本語訳
- **間違い選択肢**: 同級の他の単語から3つランダム選択

### 回答処理
- **選択時**: 選択肢の色変更、次へボタン有効化
- **次へボタン**: 
  - 正解の場合: WORD_MASTERYテーブルに記録（初回のみ）
  - 不正解の場合: SRS_MANAGEMENTテーブルに復習対象として追加/更新
  - 次の問題へ移動
- **最終問題**: テスト完了後、ユニット選択画面へ戻る

## ナビゲーション

### 問題回答後
- **条件**: 選択肢選択 + 次へボタン
- **動作**: 正解/不正解を表示
- **次の問題**: 確認後に次の問題へ進む

### テスト完了時
- **条件**: 全10問完了
- **動作**: 
  - LEARNING_PROGRESSテーブルを更新（その日のスナップショット）
  - リスニングユニット選択画面へ戻る
- **データ保存**: 
  - WORD_MASTERY: 正解した単語の習得状態
  - SRS_MANAGEMENT: 間違えた単語の復習情報
  - LEARNING_PROGRESS: 日毎の進捗スナップショット（updateOrCreate）

### 中断時
- **戻るボタン**: テスト途中でもリスニングユニット選択画面へ戻る
- **確認ダイアログ**: 「テストを中断しますか？」
- **進捗破棄**: 現在のテスト結果は保存しない

## エラーハンドリング

### 音声再生失敗
- **対応**: エラーメッセージ表示「音声の再生に失敗しました」
- **代替**: 韓国語テキストを表示（フォールバック）
- **継続**: 次の問題へスキップ可能

### 問題データなし
- **対応**: エラーメッセージ表示後、ユニット選択画面へ戻る
- **メッセージ**: 「問題データの読み込みに失敗しました」

### 不正な選択肢データ
- **対応**: 選択肢が4つ未満の場合、ランダムで補完
- **フォールバック**: 同級の他単語から選択肢生成

## 技術要件

### 必要なデータ
- ナビゲーションパラメータから級+ユニット情報を取得
- **データベース**: WORDSテーブルから指定ユニットの単語データ（10問分）
- **getWordsByUnitId query**: ユニットIDで単語一覧を取得
- **ランダム選択肢生成**: 同級語彙データから間違い選択肢3つを生成
- 各単語の音声ファイル（ファイルパスルールで自動生成）

### データベーステーブル
- **WORD_MASTERY**: テスト正解による語彙習得記録
- **SRS_MANAGEMENT**: テスト間違いによる復習対象管理
- **LEARNING_PROGRESS**: 日毎の進捗スナップショット

---
*ファイル作成日: 2025/6/13*
*実装担当: AIエージェント*