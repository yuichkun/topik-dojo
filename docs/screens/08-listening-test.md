# リスニングテスト画面 仕様書

## 画面概要
選択されたユニットの単語を音声で出題し、4択の日本語訳から正解を選ぶテスト画面。

## レイアウト構成
- **ヘッダー**: 級+ユニット表示、進捗表示、戻るボタン
- **メインエリア**: 音声プレイヤー + 4択選択肢
- **フッター**: 次へボタン、音声再生ボタン

## UI要素詳細

### ヘッダー部分
- **級+ユニット表示**: 例「3級 リスニングテスト ユニット1-10 (5/10)」
- **進捗バー**: 現在の問題番号/総問題数の視覚表示
- **戻るボタン**: リスニングユニット選択画面へ戻る
- **配置**: 画面上部

### 音声プレイヤーエリア
- **音声再生ボタン**: 大きな再生ボタン（中央配置）
- **自動再生**: 画面表示時に自動で音声再生
- **再生回数制限**: なし（何度でも再生可能）
- **配置**: 画面中央上部

### 4択選択肢
- **選択肢表示**: 4つの日本語訳を縦並びで表示
- **選択状態**: タップで選択、選択中は色変更
- **選択肢生成**: 正解+似た意味の間違い選択肢3つ
- **配置**: 画面中央下部

### 操作ボタン
- **次へボタン**: 選択肢を選んだ後に有効化
- **音声再生ボタン**: 音声プレイヤーとは別の小さなボタン（フッター）
- **配置**: 画面下部

## 状態管理

### 画面パラメータ
- **級情報**: ナビゲーションパラメータで管理（例: `grade: 3`）
- **ユニット情報**: ナビゲーションパラメータで管理（例: `unit: 1`）
- **表示**: ヘッダー部分に級+ユニット表示

### テスト進捗管理
- **現在位置**: 何問目かをローカル状態で管理
- **回答状況**: 各問題の正解/不正解を記録
- **所要時間**: 問題ごとの回答時間を記録（将来の分析用）

## データ構造

### 問題データ
```javascript
{
  id: "word_001",
  korean: "안녕하세요",
  audio_url: "/audio/word_001.mp3",
  correct_answer: "こんにちは",
  options: [
    "こんにちは",      // 正解
    "さようなら",      // 間違い選択肢
    "ありがとう",      // 間違い選択肢
    "すみません"       // 間違い選択肢
  ]
}
```

### テスト結果データ
```javascript
{
  grade: 3,
  unit: 1,
  test_type: "listening",
  results: [
    { word_id: "word_001", correct: true, time: 5.2 },
    { word_id: "word_002", correct: false, time: 12.8 }
  ],
  total_score: 8,
  total_questions: 10,
  test_date: "2025-06-13T10:30:00Z"
}
```

## 機能詳細

### 音声再生
- **トリガー**: 画面表示時自動再生 + 手動ボタン
- **実装**: Expo AVまたはReact Native Sound
- **フォールバック**: 音声ファイルが存在しない場合はエラー表示

### 選択肢生成
- **正解**: 単語の正しい日本語訳
- **間違い選択肢**: 同級の他の単語から3つ選択
- **優先順位**: 似た意味 > 同じ品詞 > ランダム

### 回答処理
- **選択時**: 選択肢の色変更、次へボタン有効化
- **次へボタン**: 回答記録 + 次の問題へ移動
- **最終問題**: テスト結果画面へ遷移

## ナビゲーション

### 問題回答後
- **条件**: 選択肢選択 + 次へボタン
- **動作**: 正解/不正解を表示
- **次の問題**: 確認後に次の問題へ進む

### テスト完了時
- **条件**: 全10問完了
- **動作**: テスト結果を記録してリスニングユニット選択画面へ戻る
- **データ保存**: 1問ごとにテスト結果をローカルストレージに保存

### 中断時
- **戻るボタン**: テスト途中でもリスニングユニット選択画面へ戻る
- **確認ダイアログ**: 「テストを中断しますか？」
- **進捗破棄**: 現在のテスト結果は保存しない

## エラーハンドリング

### 音声再生失敗
- **対応**: エラーメッセージ表示「音声の再生に失敗しました」
- **代替**: 韓国語テキストを表示（フォールバック）
- **継続**: 次の問題へスキップ可能

### 問題データなし
- **対応**: エラーメッセージ表示後、ユニット選択画面へ戻る
- **メッセージ**: 「問題データの読み込みに失敗しました」

### 不正な選択肢データ
- **対応**: 選択肢が4つ未満の場合、ランダムで補完
- **フォールバック**: 同級の他単語から選択肢生成

## 技術要件

### 必要なデータ
- ナビゲーションパラメータから級+ユニット情報を取得
- 指定されたユニットの単語データ（10問分）
- 各単語の音声ファイル
- 間違い選択肢生成用の同級語彙データ

### ローカルストレージ
- テスト結果（問題別詳細 + 全体スコア）
- テスト履歴（日時、スコア、所要時間）
- 間違えた問題の記録（復習用）

---
*ファイル作成日: 2025/6/13*
*実装担当: AIエージェント*